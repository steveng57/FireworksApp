name: release

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROJECT_PATH: FireworksApp.csproj
  CONFIGURATION: Release
  RUNTIME: win-x64
  PUBLISH_DIR: bin/Release/net10.0-windows/win-x64/publish
  PACKAGE_CERT_SUBJECT: ${{ secrets.MSIX_PUBLISHER_SUBJECT }}
  PACKAGE_CERT_PASSWORD: ${{ secrets.MSIX_CERT_PASSWORD }}
  PACKAGE_CERT_PFX_BASE64: ${{ secrets.MSIX_CERT_PFX_BASE64 }}

jobs:
  build-publish-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Read version from project
        id: version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $xml = [xml](Get-Content "${{ env.PROJECT_PATH }}")

          # Prefer <Version>; fall back to <PackageVersion> if used.
          $version = $xml.Project.PropertyGroup.Version | Select-Object -First 1
          if ([string]::IsNullOrWhiteSpace($version)) {
            $version = $xml.Project.PropertyGroup.PackageVersion | Select-Object -First 1
          }

          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "No <Version> (or <PackageVersion>) found in ${{ env.PROJECT_PATH }}"
          }

          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

          $parts = $version.Split('.')
          if ($parts.Length -lt 4) {
            $appxVersion = "$version.0"
          } else {
            $appxVersion = $version
          }

          "APPX_VERSION=$appxVersion" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Publish (self-contained, single-file)
        run: >-
          dotnet publish ${{ env.PROJECT_PATH }}
          -c ${{ env.CONFIGURATION }}
          -r ${{ env.RUNTIME }}
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:DebugType=None
          -p:DebugSymbols=false

      - name: Create release folder
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path "${{ env.PUBLISH_DIR }}")) { throw "Publish directory not found: ${{ env.PUBLISH_DIR }}" }
          New-Item -ItemType Directory -Path dist -Force | Out-Null

          # Copy publish output
          Copy-Item -Path "${{ env.PUBLISH_DIR }}\*" -Destination dist -Recurse -Force

          # Ensure shaders are included even if publish trimming changes behavior
          if (Test-Path "Shaders") {
            Copy-Item -Path "Shaders" -Destination dist -Recurse -Force
          }

      - name: Load signing certificate (persistent)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:PACKAGE_CERT_PFX_BASE64)) {
            throw "Missing secret: MSIX_CERT_PFX_BASE64"
          }
          if ([string]::IsNullOrWhiteSpace($env:PACKAGE_CERT_PASSWORD)) {
            throw "Missing secret: MSIX_CERT_PASSWORD"
          }
          if ([string]::IsNullOrWhiteSpace($env:PACKAGE_CERT_SUBJECT)) {
            throw "Missing secret: MSIX_PUBLISHER_SUBJECT"
          }

          $certPath = Join-Path $env:RUNNER_TEMP 'msix-cert.pfx'
          [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String($env:PACKAGE_CERT_PFX_BASE64))

          "PACKAGE_CERT_PATH=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Generate MSIX layout
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $assets = Join-Path "dist" "Assets"
          New-Item -ItemType Directory -Path $assets -Force | Out-Null

          Add-Type -AssemblyName System.Drawing
          function New-Logo($path, $size) {
            $bmp = New-Object System.Drawing.Bitmap $size, $size
            $g = [System.Drawing.Graphics]::FromImage($bmp)
            $g.Clear([System.Drawing.Color]::FromArgb(255, 30, 46, 110))
            $g.FillEllipse([System.Drawing.Brushes]::White, $size * 0.2, $size * 0.2, $size * 0.6, $size * 0.6)
            $g.Dispose()
            $bmp.Save($path, [System.Drawing.Imaging.ImageFormat]::Png)
            $bmp.Dispose()
          }

          New-Logo (Join-Path $assets 'Square150x150Logo.png') 150
          New-Logo (Join-Path $assets 'Square44x44Logo.png') 44

          $manifestPath = Join-Path "dist" "AppxManifest.xml"
          $manifest = @"
<?xml version="1.0" encoding="utf-8"?>
<Package
  xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
  xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
  xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities"
  IgnorableNamespaces="uap rescap">
  <Identity Name="FireworksApp" Publisher="${{ env.PACKAGE_CERT_SUBJECT }}" Version="${{ env.APPX_VERSION }}" ProcessorArchitecture="x64" />
  <Properties>
    <DisplayName>FireworksApp</DisplayName>
    <PublisherDisplayName>FireworksApp</PublisherDisplayName>
    <Logo>Assets\Square150x150Logo.png</Logo>
  </Properties>
  <Dependencies>
    <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxTestedVersion="10.0.22631.0" />
  </Dependencies>
  <Resources>
    <Resource Language="en-us" />
  </Resources>
  <Applications>
    <Application Id="App" Executable="FireworksApp.exe" EntryPoint="Windows.FullTrustApplication">
      <uap:VisualElements
        DisplayName="FireworksApp"
        Description="Fireworks simulation"
        BackgroundColor="transparent"
        Square150x150Logo="Assets\Square150x150Logo.png"
        Square44x44Logo="Assets\Square44x44Logo.png" />
    </Application>
  </Applications>
  <Capabilities>
    <rescap:Capability Name="runFullTrust" />
  </Capabilities>
</Package>
"@
          $manifest | Set-Content -Path $manifestPath -Encoding UTF8

      - name: Create MSIX package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $msixName = "FireworksApp-${{ env.VERSION }}-${{ env.RUNTIME }}.msix"
          $msixPath = Join-Path $pwd $msixName

          & makeappx.exe pack /d dist /p $msixPath /o

          & signtool.exe sign /fd SHA256 /f "${{ env.PACKAGE_CERT_PATH }}" /p "${{ env.PACKAGE_CERT_PASSWORD }}" $msixPath

          "MSIX_NAME=$msixName" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: FireworksApp v${{ env.VERSION }}
          generate_release_notes: true
          files: |
            ${{ env.MSIX_NAME }}
