name: release

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROJECT_PATH: FireworksApp.csproj
  CONFIGURATION: Release
  RUNTIME: win-x64
  PUBLISH_DIR: bin/Release/net10.0-windows/win-x64/publish

jobs:
  build-publish-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Read version from project
        id: version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $xml = [xml](Get-Content "${{ env.PROJECT_PATH }}")

          # Prefer <Version>; fall back to <PackageVersion> if used.
          $version = $xml.Project.PropertyGroup.Version | Select-Object -First 1
          if ([string]::IsNullOrWhiteSpace($version)) {
            $version = $xml.Project.PropertyGroup.PackageVersion | Select-Object -First 1
          }

          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "No <Version> (or <PackageVersion>) found in ${{ env.PROJECT_PATH }}"
          }

          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Publish (self-contained, single-file)
        run: >-
          dotnet publish ${{ env.PROJECT_PATH }}
          -c ${{ env.CONFIGURATION }}
          -r ${{ env.RUNTIME }}
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:DebugType=None
          -p:DebugSymbols=false

      - name: Create release folder
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path "${{ env.PUBLISH_DIR }}")) { throw "Publish directory not found: ${{ env.PUBLISH_DIR }}" }
          New-Item -ItemType Directory -Path dist -Force | Out-Null

          # Copy publish output
          Copy-Item -Path "${{ env.PUBLISH_DIR }}\*" -Destination dist -Recurse -Force

          # Ensure shaders are included even if publish trimming changes behavior
          if (Test-Path "Shaders") {
            Copy-Item -Path "Shaders" -Destination dist -Recurse -Force
          }

      - name: Zip artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ env.VERSION }}"
          $zipName = "FireworksApp-$version-${{ env.RUNTIME }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName
          "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: FireworksApp v${{ env.VERSION }}
          generate_release_notes: true
          files: |
            ${{ env.ZIP_NAME }}
